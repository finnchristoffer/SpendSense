name: DocC

on:
  push:
    branches: [main]
    paths:
      - '**/*.swift'
      - '**/*.md'
      - '**/*.docc/**'
  pull_request:
    branches: [main]
    paths:
      - '**/*.swift'
      - '**/*.md'
      - '**/*.docc/**'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: docc-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Documentation
    runs-on: macos-15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'
      
      - name: Prepare Xcode
        run: |
          sudo xcodebuild -license accept
          sudo xcodebuild -runFirstLaunch
      
      - name: Prepare Simulator Service
        run: |
          # Kill any existing simulator services to ensure a clean slate
          sudo killall -9 com.apple.CoreSimulator.CoreSimulatorService || true
          # Give time for cleanup
          sleep 5
      
      - name: Install iOS Simulator Runtime
        uses: nick-invision/retry@v3
        with:
          timeout_minutes: 20
          max_attempts: 3
          retry_wait_seconds: 60
          command: |
            echo "Downloading iOS platform..."
            xcodebuild -downloadPlatform iOS
      
      - name: Boot Simulator
        run: |
          echo "Available runtimes:"
          xcrun simctl list runtimes
          
          echo "Available devices:"
          xcrun simctl list devices available
          
          # Boot a simulator to ensure service is ready
          DEVICE_UDID=$(xcrun simctl list devices available -j | jq -r '.devices | to_entries | map(select(.key | contains("iOS"))) | .[0].value | .[0].udid' 2>/dev/null || echo "")
          
          if [ -n "$DEVICE_UDID" ]; then
            echo "Booting simulator: $DEVICE_UDID"
            xcrun simctl boot "$DEVICE_UDID" || true
            sleep 5
          fi
      
      - name: Install Mise
        uses: jdx/mise-action@v2
        with:
          install: true
      
      - name: Fetch Dependencies
        run: tuist install
      
      - name: Generate Project
        run: tuist generate --no-open
      
      - name: Build Project First
        run: |
          tuist build RAWGApp -- \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
            -derivedDataPath DerivedData \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
      
      - name: Build Documentation
        run: |
          # Define ALL schemes to build documentation for
          SCHEMES=("RAWGApp" "Core" "CoreNavigation" "CoreNetwork" "CoreUI" "Common")
          
          for SCHEME in "${SCHEMES[@]}"; do
            echo "Building documentation for $SCHEME..."
            xcodebuild docbuild \
              -workspace RAWG.xcworkspace \
              -scheme "$SCHEME" \
              -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
              -derivedDataPath DerivedData \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO || echo "Warning: docbuild failed for $SCHEME, continuing..."
          done
      
      - name: Process Documentation
        run: |
          mkdir -p docs
          
          # Find all doccarchives and process them
          echo "Found documentation archives:"
          find DerivedData -name "*.doccarchive" -type d
          
          find DerivedData -name "*.doccarchive" -type d | while read archive; do
            echo "Processing $archive..."
            
            # Extract target name from archive path
            TARGET_NAME=$(basename "$archive" .doccarchive)
            
            # Process archive for static hosting
            $(xcrun --find docc) process-archive \
              transform-for-static-hosting "$archive" \
              --hosting-base-path "RAWG.IO/$TARGET_NAME" \
              --output-path "docs/$TARGET_NAME"
            
            echo "Processed $TARGET_NAME"
          done
          
          # Debug: Show what was created
          echo "Created documentation folders:"
          ls -la docs/
      
      - name: Create Index Page
        run: |
          # Create a styled index.html that links to the docs
          cat > docs/index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>RAWG.IO Documentation</title>
            <style>
              :root {
                --background: #1c2128;
                --surface: #2d333b;
                --primary: #58a6ff;
                --text: #adbac7;
                --text-heading: #f0f6fc;
              }
              * { box-sizing: border-box; margin: 0; padding: 0; }
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: var(--background);
                color: var(--text);
                min-height: 100vh;
                padding: 40px 20px;
              }
              .container { max-width: 900px; margin: 0 auto; }
              h1 {
                color: var(--text-heading);
                font-size: 2.5rem;
                margin-bottom: 8px;
              }
              .subtitle {
                color: var(--text);
                margin-bottom: 40px;
                font-size: 1.1rem;
              }
              .section-title {
                color: var(--text-heading);
                font-size: 1.3rem;
                margin: 30px 0 15px 0;
                border-bottom: 1px solid var(--surface);
                padding-bottom: 8px;
              }
              .modules { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
              .module {
                background: var(--surface);
                border-radius: 10px;
                padding: 16px;
                text-decoration: none;
                color: var(--text);
                transition: transform 0.2s, box-shadow 0.2s;
              }
              .module:hover {
                transform: translateY(-3px);
                box-shadow: 0 6px 20px rgba(0,0,0,0.3);
              }
              .module-name {
                color: var(--primary);
                font-weight: 600;
                font-size: 1rem;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>ðŸ“š RAWG.IO Documentation</h1>
              <p class="subtitle">Swift documentation for all modules</p>
              
              <h2 class="section-title">ðŸŽ® App</h2>
              <div class="modules" id="app-modules"></div>
              
              <h2 class="section-title">ðŸ”§ Core Modules</h2>
              <div class="modules" id="core-modules"></div>
              
            </div>
            <script>
              const modules = {
                app: ['RAWGApp'],
                core: ['Core', 'CoreUI', 'CoreNetwork', 'CoreNavigation', 'Common']
              };
              
              function addModule(container, name) {
                const lowerName = name.toLowerCase();
                const link = document.createElement('a');
                link.className = 'module';
                link.href = name + '/documentation/' + lowerName + '/';
                link.innerHTML = '<div class="module-name">' + name + '</div>';
                document.getElementById(container).appendChild(link);
              }
              
              modules.app.forEach(m => addModule('app-modules', m));
              modules.core.forEach(m => addModule('core-modules', m));
            </script>
          </body>
          </html>
          HTMLEOF
      
      - name: Upload Pages Artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

  deploy:
    name: Deploy to GitHub Pages
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4